# esp_wifiiot/pzem_rtos_own

Работа с PZEM004t не используя уже готовую опцию прошивки wifi-iot (https://wifi-iot.com/p/wiki/15/).

Смысл данного изобретения - читать многократно один параметр (несколько раз непрерывно за определенный момент времени), например, силу тока для реализации "реле приоритетов нагрузки"

Готовый модуль прошивки PZEM004t может читать данные с устройства не чаще 1 раза в секунду и всего 2 параметра за один раз, причем первое чтение - напряжение и ток, второе чтение - мощность и расход, что не устраивает, и необходимо читать 1 параметр многократно, 1 раз в полсекунды (обусловлено временем ответа устройства на команды).

Данный код читает параметры с устройства постоянно по следующему алгоритму:
* один цикл чтения составляет 120 интераций (примерно 60 сек)
* значение израсходованной энергии (energy) читается каждую 120-ю итерацию, т.е. примерно 1 раз в минуту
* значение напряжения (voltage) читается каждую 8-ю итерацию, т.е. примерно 1 раз в 2 секунды
* значение мощности (power) читается каждую 8-ю итерацию, т.е. примерно 1 раз в 2 секунды
* все остальные итерации отданы под чтение силы тока (current), т.е. примерно 1 раз в 500 мсек, за исключением каждой 4-ой и 60-ой секунд

**Никаких опций, использующих uart, в прошивке включать не надо!**

Настройки:
* Чтение данных с PZEM004t начинается только через 40 секунд после старта модуля. Сделано для того, чтобы после рестарта можно было успеть обновить прошивку через web, если начали возникать какие-то проблемы с модулем при чтении данных с PZEM.
Данную задержку можно поменять здесь DELAYED_START
* Работу с модулем можно вкл/выкл через опцию "Enable PZEM", которую нужно задать в прошивке ().
![alt text](https://github.com/d51x/esp_wifiiot/blob/master/pzem_rtos_own/CodeOptions.PNG)
* параметр #define DEBUG позволяет вести отладку устройства, данные будут направляться в UART1 (GPIO2)

Значение параметра:
* 0 - чтение данных с устройства не происходит
* 1 - чтение данных с устройства разрешено (1 или любое другое число кроме 0)


Планы:
* добавить отправку по mqtt, если модуль mqtt подключен и включена отправка по mqtt.
  Нужна будет опция, в которой:
  - 0 - дефолтный интервал отправки данных по mqtt, который указывает в настройках опции mqtt
  - 1..X - любое целое положительное число, означает собственное время отправки в "сек"
* переинициализацию модуля при изменении данных без перезагрузки модуля


PS Код основан на проекте для Arduino (https://github.com/olehs/PZEM004T)
