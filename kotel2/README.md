# esp_wifiiot/kotel2

Управление котлами (основным и дополнительным) по расписанию.
У меня 2 котла. Электрический и жидкотопливный.

![alt text](https://github.com/d51x/esp_wifiiot/blob/master/kotel2/main.png)

Текущая модификация через КК позволяет в автоматическом режиме:
1. включать электрический котел (Котел 2) только в ночное время (23-7)
2. включать жидкотопливный котел (Котел 1) в дневное время (7-23)
3. использовать как глобальную уставку (расписание выключено), так и изменение уставки по расписанию
4. выждать время выбега насоса Котла 2 после его отключения и только после этого включить Котел 1, т.к. у него свой насос

Доступно 4 режима работы:
1. ручной режим - ничего автоматически не работает (т.е. термостат отключен)
   управление все ручное - нужный котел включаем руками
2. автоматический режим - все работает, как описано выше, включается термостат и управляет котлами по уставке
3. Котел 1 - работает в автоматическом режиме (термостат) как по глобальной уставке, так и по расписанию
4. Котел 2 - аналогично Котлу 1, только учитывается кнопка Ночной режим

Термостат использует переменную температуры, которая заполняется функцией get_temp().
Поэтому находим эту функцию и прописываем с какого датчика брать температуру.
Можно указать локальные датчики: data1wire[X], или dht_tX, или другой датчик
Либо вообще описать свою логику для вычисления температуры.
Например, брать минимальную (или среднюю) температуру из 3-х указанных, которые мы получаем через VSENS

    _temp =  vsens[0][0];

    //******* работаем по средней температуре
    //_temp = (_temp + vsens[1][1]) / 2;
    //_temp = (_temp + vsens[1][2]) / 2;
    //****************************************

    //******* работаем по минимальной  температуре
    _temp = ( _temp < vsens[1][0] ) ? _temp : vsens[1][0];
    _temp = ( _temp < vsens[2][0] ) ? _temp : vsens[2][0];


**Настройка опций**
При сборке прошивки в опции Конструктор кода нужно указать следующее:
* глобальные переменные - 3
* кол-во настроек - Авто,Разрешен,Период/сек,Гистерезис/x10,Уставка/x10,Задержка насоса/сек,Расписание,ЧЧММ-1,Уст1/x10,ЧЧММ-2,Уст2/x10,ЧЧММ-3,Уст3/x10,ЧЧММ-4,Уст4/x10,ЧЧММ-5,Уст5/x10

Так же требуется в опциях прошивки включить следующие опции:
* WebKey с галкой "AJAX (без перезагрузки страницы)". Расширеный режим можно не включать, кол-во кнопок не принципиально. Потом данный блок вообще будет скрыт с главной страницы и его нет смысла настраивать.
  Если кому то нужен этот блок на главной, то в исходниках найдите следующее и закоментируйте
  
    " if ( gg[1].innerHTML == \"GPIO:\")"
    " { gg[1].style.display=\"none\";"
    "document.getElementsByClassName(\"c\")[1].style.display=\"none\";"
    "}"  

* опция GPIO
* опция Virtual SENS, если будете использовать температуру с других устройств для термостата
* конструктор main page 2, если будете использовать Virtual SENS и не хотите видеть как эта опция выводит данные
  можно настроить свой вывод, например в таком виде
  **Температура в комнатах 23.5 / 24.1 / 22.9**
  
  У меня настроено так

    <b>Подача:</b>  _DSW1_°C<br>
    <b>Обратка:</b> _DSW2_°C<br>
    <b>Комната:</b> _VS11_°C / _VS21_°C / _VS31_°C<br>
    <b>Улица:</b>   _VS41_°C  

  и выглядит так

    Подача: 34.9°C
    Обратка: 33.2°C
    Комната: 24.6°C / 24.6°C / 24.9°C
    Улица: 14.3°C  

 
![alt text](https://github.com/d51x/esp_wifiiot/blob/master/kotel2/options.png)

Теперь по пунктам
1. Авто - режим работы 
  0 - ручной (без термостата)
  1 - автоматический (термостат)
  2 - Всегда котел 1 (термостат)
  3 - всегда котел 2 (термостат)
  
2. Разрешен - не трогаем эту настройку, она лишняя (выпилить ее надо)
3. Период/сек - период сработки термостата, в секундах
4. Гистерезис/x10 - настройка гистерезиса, реальное значение гистерезиса, умноженное на 10, т.е. для гистерезица в 0,5 градуса надо указать 5, для 1 градуса - 10
5. Уставка/x10 - глобальная уставка, значение температуры, умноженное на 10, для уставки в 24.5 градуса указываем 245. Данная уставка используется при выключенном расписании. При включенном расписании глобальная уставка не используется
6. Задержка насоса/сек - время выбега насоса Котла 2. Если был активный Котел 2, он выключился, а потом надо включится Котлу 1, то Котел 1 включится не сразу, а только после того, как пройдет указанное время.
7. Расписание - использование расписания уставок. 0- расписание выключено, 1 - расписание включено. 
    Сейчас доступно 5 временных интервалов в расписании. 
	Время интервала означает во сколько данный интервал начинает действовать.
	Первый интервал всегда должен начинаться с 00:00 и укзанием реальной уставки температуры.
    Далее настраиваются остальные 4 интервала. Каждый интервал по времени должен быть больше предыдущего.
	Время действия последнего интервала с указанного времени до 23:59.
	Время интервалов указывается как ЧЧММ без знака **:** (двоеточие).
	Т.е. времени 00:00 соответствует число 0. Времени 7:30 соответствует 730. Далее 15:45 аналогично 1545.
	Уставка температуры для интервала указывается как температура х 10. Т.е. для уставки в 24.5 градуса надо указать 245
	CFG_TEMPSET_SCHEDULE_COUNT - можно изменить кол-во временных интервалов, но не более 7
8. ЧЧММ-1 - время начала 1-го временного интервала
9. Уст1/x10 - уставка температуры 1-го временного интервала
и т.д.

Управлять некоторыми параметрами можно удаленно (http get или mqtt) через valdes - переменные.
Пока что доступно:
valdes0 - режим работы
valdes1 - состояние термостата (только отправка)
valdes2 - вкл/выкл расписание
