# esp_wifiiot/kotel2

Управление котлами (основным и дополнительным) по расписанию.<br>
У меня 2 котла. Электрический и жидкотопливный.

![alt text](https://github.com/d51x/esp_wifiiot/blob/master/kotel2/main.png)

**Текущая модификация через КК позволяет в автоматическом режиме:**
1. включать электрический котел (Котел 2) только в ночное время (23-7)
2. включать жидкотопливный котел (Котел 1) в дневное время (7-23)
3. использовать как глобальную уставку (расписание выключено), так и изменение уставки по расписанию
4. выждать время выбега насоса Котла 2 после его отключения и только после этого включить Котел 1, т.к. у него свой насос

**Доступно 4 режима работы:**
1. ручной режим - ничего автоматически не работает (т.е. термостат отключен)
   управление все ручное - нужный котел включаем руками
2. автоматический режим - все работает, как описано выше, включается термостат и управляет котлами по уставке
3. Котел 1 - работает в автоматическом режиме (термостат) как по глобальной уставке, так и по расписанию
4. Котел 2 - аналогично Котлу 1, только учитывается кнопка Ночной режим

Названия *Котел1* и *Котел2* можно изменить в коде.<br>
//#define KOTEL1_NAME "дизельный"<br>
#define KOTEL1_NAME "Котел1"<br>
//#define KOTEL2_NAME "электрический"<br>
#define KOTEL2_NAME "Котел2<br>

GPIO под котлы также изменяется в коде.<br>
#define KOTEL1_GPIO 15 <br>
#define KOTEL2_GPIO 13 // !!!! если не нужен котел 2, просто закоментируйте <br>

Ночной режим (GPIO для эл.котлов Protherm, перемычка ESC X2)<br>
#define KOTEL2_NIGHT_MODE_GPIO 16 // если не нужно, закоментируйте<br>

Термостат использует переменную температуры, которая заполняется функцией get_temp().<br>
Поэтому находим эту функцию и прописываем с какого датчика брать температуру.<br>
Можно указать локальные датчики: data1wire[X], или dht_tX, или другой датчик<br>
Либо вообще описать свою логику для вычисления температуры.<br>
Например, брать минимальную (или среднюю) температуру из 3-х указанных, которые мы получаем через VSENS<br>

```
    _temp =  vsens[0][0];

    //******* работаем по средней температуре
    //_temp = (_temp + vsens[1][1]) / 2;
    //_temp = (_temp + vsens[1][2]) / 2;
    //****************************************

    //******* работаем по минимальной  температуре
    _temp = ( _temp < vsens[1][0] ) ? _temp : vsens[1][0];
    _temp = ( _temp < vsens[2][0] ) ? _temp : vsens[2][0];
```
Так же есть возможность испольовать температуру с внешнего устройства.<br>
Ее надо передавать в valdes[4], а так же включить параметр "Источник температуры" ( выставить 1).<br>

**Настройка опций**
При сборке прошивки в опции Конструктор кода нужно указать следующее:
* глобальные переменные - 5:
* кол-во настроек - Авто,Источник температуры,Период/сек,Гистерезис/x10,Уставка/x10,Задержка насоса/сек,Расписание,ЧЧММ-1,Уст1/x10,ЧЧММ-2,Уст2/x10,ЧЧММ-3,Уст3/x10,ЧЧММ-4,Уст4/x10,ЧЧММ-5,Уст5/x10

Так же требуется в опциях прошивки включить следующие опции:
* WebKey с галкой "AJAX (без перезагрузки страницы)". Расширеный режим можно не включать, кол-во кнопок не принципиально. Потом данный блок вообще будет скрыт с главной страницы и его нет смысла настраивать.<br>
  Если кому то нужен этот блок на главной, то в исходниках найдите __#define HIDE_GPIO_BLOCK__ и закоментируйте строку

* опция GPIO
* опция Virtual SENS, если будете использовать температуру с других устройств для термостата
* конструктор main page 2, если будете использовать Virtual SENS и не хотите видеть как эта опция выводит данные
  можно настроить свой вывод, например в таком виде
  **Температура в комнатах 23.5 / 24.1 / 22.9**
  
  У меня настроено так<br>
```
    <b>Подача:</b>  _DSW1_°C<br>
    <b>Обратка:</b> _DSW2_°C<br>
    <b>Комната:</b> _VS11_°C / _VS21_°C / _VS31_°C<br>
    <b>Улица:</b>   _VS41_°C  
```
  и выглядит так<br>
```
    Подача: 34.9°C
    Обратка: 33.2°C
    Комната: 24.6°C / 24.6°C / 24.9°C
    Улица: 14.3°C  
```
 
![alt text](https://github.com/d51x/esp_wifiiot/blob/master/kotel2/options.png)

Теперь по пунктам
1. Авто - режим работы 
  * 0 - ручной (без термостата)
  * 1 - автоматический (термостат)
  * 2 - Всегда котел 1 (термостат)
  * 3 - всегда котел 2 (термостат)
  
2. Источник температуры - значение 0 - используется вычисление температуры на устройстве, 1 - используется внешняя температуры через valdes4
3. Период/сек - период сработки термостата, в секундах
4. Гистерезис/x10 - настройка гистерезиса, реальное значение гистерезиса, умноженное на 10, т.е. для гистерезица в 0,5 градуса надо указать 5, для 1 градуса - 10
5. Уставка/x10 - глобальная уставка, значение температуры, умноженное на 10, для уставки в 24.5 градуса указываем 245. Данная уставка используется при выключенном расписании. При включенном расписании глобальная уставка не используется
6. Задержка насоса/сек - время выбега насоса Котла 2. Если был активный Котел 2, он выключился, а потом надо включится Котлу 1, то Котел 1 включится не сразу, а только после того, как пройдет указанное время.
7. Расписание - использование расписания уставок. 0- расписание выключено, 1 - расписание включено.<br> 
    Сейчас доступно 5 временных интервалов в расписании.<br> 
	Время интервала означает во сколько данный интервал начинает действовать.<br>
	Первый интервал всегда должен начинаться с 00:00 и укзанием реальной уставки температуры.<br>
    Далее настраиваются остальные 4 интервала. Каждый интервал по времени должен быть больше предыдущего.<br>
	Время действия последнего интервала с указанного времени до 23:59.<br>
	Время интервалов указывается как ЧЧММ без знака **:** (двоеточие).<br>
	Т.е. времени 00:00 соответствует число 0. Времени 7:30 соответствует 730. Далее 15:45 аналогично 1545.<br>
	Уставка температуры для интервала указывается как температура х 10. Т.е. для уставки в 24.5 градуса надо указать 245<br>
	CFG_TEMPSET_SCHEDULE_COUNT - можно изменить кол-во временных интервалов, но не более 7<br>
8. ЧЧММ-1 - время начала 1-го временного интервала
9. Уст1/x10 - уставка температуры 1-го временного интервала
и т.д.

Управлять некоторыми параметрами можно удаленно (http get или mqtt) через valdes - переменные.<br>
* valdes0 - режим работы
* valdes1 - гистерезис
* valdes2 - уставка
* valdes3 - расписание
* valdes4 - внешняя температура

