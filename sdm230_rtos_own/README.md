# esp_wifiiot/sdm230_rtos_own

Работа с SDM230 не используя уже готовую опцию "ModBus master" прошивки wifi-iot (https://wifi-iot.com/p/wiki/210/).

Смысл данного изобретения - читать многократно один параметр (несколько раз непрерывно за определенный момент времени), например, силу тока для реализации "реле приоритетов нагрузки"

Готовый модуль прошивки "ModBus master" может читать данные с устройства только в определенно заданной последовательности, т.е. параметры друг за другом - напряжени -> ток -> мощность -> расход -> и т.д. Более того, что в виду особенностей SDM230 регистры с параметрами расположены не друг за другом, а в разном интервале, поэтому требуется настроить несколько устройств с одним и тем же адресом устройства в одной опции, в каждой опции указывать начальный адрес первого регистра и кол-во регистров для чтения. Получается что нужно настроить в опции 3 устройства, первое читает - напряжение, ток, мощность, второе - расход общий, третье - расход обнуляемый. В итоге 5 параметров опция читает корректно только если выставить интервал чтения датчиков не менее 3 секунды (иногда срабатывает и 2 сек), в противном случае параметры перемещиваются, т.е. в напряжение может попасть значение расхода, а в ток - значение мощности.

Само устройство отдает результат чтения региста очень быстро - 40 мсек на запрос-получение данных из регистра. Таким образом за 1 секунду можно прочитать показание тока 20 раз и по одному разу значения напряжения и мощности. Такой подход дает очнь большую мощь в реализации функционала "реле приоритетов нагрузки".

Данный код читает параметры с устройства постоянно по следующему алгоритму:

(вариант 1 - 120 интераций)
* один цикл чтения составляет 120 интераций (примерно 6 сек)
* значение израсходованной энергии (energy) читается каждую 120-ю итерацию, т.е. примерно 1 раз в 6 сек
* значение напряжения (voltage) читается каждую 8-ю итерацию, т.е. примерно 3 раза в 1 сек
* значение мощности (power) читается каждую 8-ю итерацию, т.е. примерно 3 раза в 1 сек
* все остальные итерации отданы под чтение силы тока (current), т.е. примерно 1 раз в 40 мсек, или 18 раз в 1 сек, за исключением каждой 4-ой и 6-ой секунд

(вариант 2)
* последовательное чтение значения силы тока - 20 раз подряд ( ~ 1 сек)
* следом чтение значений напряжения и мощности
* значение общего и сбрасываемого расходов - 1 раз в 10 сек

**Никаких опций, использующих uart, в прошивке включать не надо!**

Настройки:
* Чтение данных с SDM230 начинается только через 40 секунд после старта модуля. Сделано для того, чтобы после рестарта можно было успеть обновить прошивку через web, если начали возникать какие-то проблемы с модулем при чтении данных с SDM230.
Данную задержку можно поменять здесь DELAYED_START
* Работу с модулем можно вкл/выкл через опцию "SDM230 Enable", которую нужно задать в прошивке ().
![alt text](https://github.com/d51x/esp_wifiiot/blob/master/sdm230_rtos_own/CodeOptions.PNG)
* параметр #define DEBUG позволяет вести отладку устройства, данные будут направляться в UART1 (GPIO2)

Значение параметра:
* 0 - чтение данных с устройства не происходит
* 1 - чтение данных с устройства разрешено (1 или любое другое число кроме 0)


Есть возможность отправки данных с устройства по MQTT.
Данные отправляются в стандартных топиках, соответствующих PZEM (сделано для совместимости).

Напряжение 		- login/host/pmv
Сила тока		- login/host/pmс
Мощность		- login/host/pmw
Расход общий 	- login/host/pmwh

Отправка данных просиходит только при включенной галке "Enable send MQTT".
Интервал отправки задается в секундах в опции "MQTT Send Interval".
Если значение 0, то используется интервал отправки, указанный в опциях MQTT. На текущий момент стандартная опция MQTT позволяет минимальный интервал отправки - 5 сек, но при этом в реальности отправка происходит раз в 10 сек.
Если надо отправлять чаще, укажите свое значение, отличное от 0. Желательно указывать не менее 2 сек.



